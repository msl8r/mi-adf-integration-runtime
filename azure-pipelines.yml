name: HMCTS Management Information ADF Self Hosted Integration Runtime Image
trigger:
  - master

pool:
  vmImage: 'windows-latest'

parameters:
  - name: pushImage
    displayName: Push Docker Image To ACR
    type: boolean
    default: false

variables:
  projectName: 'mi'
  applicationName: 'adf-integration-runtime'
  azureSubscriptionEndpoint: 'DTS-SHAREDSERVICES-PROD'
  azureContainerRegistry: 'sdshmctspublic.azurecr.io'
  ${{ if eq(variables['Build.SourceBranchName'], 'master') }}: 
    deployTarget: prod
  ${{ if not(eq(variables['Build.SourceBranchName'], 'master')) }}: 
    deployTarget: dev

stages:
  - stage: BuildAndPush
    jobs:
      - job: BuildAndPush
        steps:
            - task: AzureCLI@1
              displayName: "ACR Login"
              inputs:
                azureSubscription: $(azureSubscriptionEndpoint)
                scriptLocation: "inlineScript"
                inlineScript: |
                  az acr login --name sdshmctspublic
            - task: AzureCLI@1
              displayName: "ACR Login"
              inputs:
                azureSubscription: $(azureSubscriptionEndpoint)
                scriptLocation: "inlineScript"
                inlineScript: |
                  az acr repository delete --name sdshmctspublic --image mi/adf-integration-runtime:dev-16bb576 --yes
            - task: AzureCLI@1
              displayName: "ACR Login"
              inputs:
                azureSubscription: $(azureSubscriptionEndpoint)
                scriptLocation: "inlineScript"
                inlineScript: |
                  az acr repository delete --name sdshmctspublic --image mi/adf-integration-runtime:dev-3c01d5e --yes
            - task: AzureCLI@1
              displayName: "ACR Login"
              inputs:
                azureSubscription: $(azureSubscriptionEndpoint)
                scriptLocation: "inlineScript"
                inlineScript: |
                  az acr repository delete --name sdshmctspublic --image mi/adf-integration-runtime:dev-f8d1cab --yes
            - task: AzureCLI@1
              displayName: "ACR Login"
              inputs:
                azureSubscription: $(azureSubscriptionEndpoint)
                scriptLocation: "inlineScript"
                inlineScript: |
                  az acr repository delete --name sdshmctspublic --image mi/adf-integration-runtime:dev-cb3da8e --yes